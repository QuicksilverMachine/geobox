{% extends 'webapp/master.html' %}
{% load staticfiles %}
{% load i18n %}

{% block css %}
    <link rel="stylesheet" href="{% static 'webapp/addons/leaflet/leaflet.css' %}" />
    <link rel="stylesheet" href="{% static 'webapp/addons/leaflet-routing-machine/leaflet-routing-machine.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'map/css/map.css' %}" />

{% endblock %}

{% block body-full %}
    <div id="map"></div>
{#    <div class="webapp-media-block-container">#}
        <div class="webapp-media-block">
            {% trans "Connected users" %}
            <br>
            <ul>
                <li>Test 1</li>
                <li>Test 2</li>
            </ul>
        </div>
{#    </div>#}
{% endblock %}

{% block js %}
    <script src="{% static 'webapp/addons/leaflet/leaflet.js' %}"></script>
    <script src="{% static 'webapp/addons/leaflet-routing-machine/leaflet-routing-machine.min.js' %}"></script>
    <script src="{% static 'webapp/addons/leaflet-routing-machine/examples/Control.Geocoder.js' %}"></script>
    <script>
        var map = L.map('map').setView([44.7986, 20.4489], 13);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicXVpY2tzaWx2ZXJtYWNoaW5lIiwiYSI6ImNpam82eGVmMzAwdHR1b2x4YzlrcXhycm0ifQ.IgzogF0Nzn9EwIflCarL-g', {
            attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.streets',
            accessToken: 'pk.eyJ1IjoicXVpY2tzaWx2ZXJtYWNoaW5lIiwiYSI6ImNpam82eGVmMzAwdHR1b2x4YzlrcXhycm0ifQ.IgzogF0Nzn9EwIflCarL-g'
        }).addTo(map);

        // placeholders for the L.marker and L.circle representing user's current position and accuracy
        var current_position, current_accuracy;

        function onLocationFound(e) {
          // if position defined, then remove the existing position marker and accuracy circle from the map
          if (current_position) {
              map.removeLayer(current_position);
              map.removeLayer(current_accuracy);
          }

          var radius = e.accuracy / 2;
          current_position = L.marker(e.latlng).addTo(map);
          current_accuracy = L.circle(e.latlng, radius).addTo(map);
        }

        map.on('locationfound', onLocationFound);

        // wrap map.locate in a function
        function locate(setView) {
            if (setView === undefined) {
                setView = false;
            }
            map.locate({setView: setView, maxZoom: 16});
        }
        var initialSetView = true;
        if({{ map.waypoint_set.count }}) {
            initialSetView = false;
        }
        locate(initialSetView);
        // call locate every 10 seconds... forever
        setInterval(locate, 10000);

        function createButton(label, container) {
            var btn = L.DomUtil.create('button', '', container);
            btn.setAttribute('type', 'button');
            btn.innerHTML = label;
            return btn;
        }

        var ReversablePlan = L.Routing.Plan.extend({
            createGeocoders: function() {
                var container = L.Routing.Plan.prototype.createGeocoders.call(this);
                var reverseButton = createButton('↑↓', container);

                L.DomEvent.on(reverseButton, 'click', function() {
                    var waypoints = this.getWaypoints(); this.setWaypoints(waypoints.reverse());
                }, this);

                return container;
            }
        });

        var plan = new ReversablePlan([
                L.latLng(44.7986, 20.4489),
                L.latLng(44.7986, 20.5489)
            ], {
                geocoder: L.Control.Geocoder.nominatim(),
                routeWhileDragging: true
            }),
            control = L.Routing.control({
                routeWhileDragging: true,
                plan: plan
            }).addTo(map);

        map.on('click', function(e) {
            var container = L.DomUtil.create('div'),
                startBtn = createButton('Start', container),
                destBtn = createButton('Goal', container);

            L.popup()
                .setContent(container)
                .setLatLng(e.latlng)
                .openOn(map);

            L.DomEvent.on(startBtn, 'click', function() {
                control.spliceWaypoints(0, 1, e.latlng);
                map.closePopup();
            });

            L.DomEvent.on(destBtn, 'click', function() {
                control.spliceWaypoints(control.getWaypoints().length - 1, 1, e.latlng);
                map.closePopup();
            });
        });

        if ($(window).width() < 640) {
            control.hide();
        }

    </script>
{% endblock %}
